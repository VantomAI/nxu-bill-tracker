<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Check Log & Finance Tracker</title>
  <style>
    /* General Styles */
    :root {
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --border-color: #334155;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --accent-color: #38bdf8;
      --accent-hover: #0ea5e9;
      --danger-color: #7f1d1d;
      --danger-hover: #991b1b;
      --success-color: #14b8a6;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
      margin: 0;
      background-color: var(--bg-primary);
      color: var(--text-primary);
      padding: 16px;
    }
    a { color: var(--accent-color); }
    h1, h2, h3 { margin-top: 0; }
    .container { max-width: 1280px; margin: 0 auto; }
    .btn {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      border-radius: 8px;
      padding: 8px 14px;
      font-size: 14px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .btn:hover { background-color: var(--border-color); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-danger { background-color: var(--danger-color); border-color: var(--danger-hover); }
    .btn-danger:hover { background-color: var(--danger-hover); }
    .btn-primary { background-color: var(--accent-color); border-color: var(--accent-hover); color: var(--bg-primary); font-weight: bold; }
    .btn-primary:hover { background-color: var(--accent-hover); }
    .card {
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }
    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
      flex-wrap: wrap;
      gap: 8px;
    }
    input, select, textarea {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .small-text { font-size: 12px; color: var(--text-secondary); }
    .hidden { display: none; }
    .actions { display: flex; align-items: center; gap: 8px; }
    .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; }

    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
    .tab-btn { background-color: transparent; border: 1px solid transparent; border-bottom: 2px solid transparent; color: var(--text-secondary); padding: 8px 12px; cursor: pointer; border-radius: 6px 6px 0 0; }
    .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); background-color: var(--bg-secondary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* Table Styles */
    table { width: 100%; border-collapse: collapse; font-size: 14px; }
    th, td { padding: 8px 6px; text-align: left; }
    th { color: var(--text-secondary); font-weight: 500; border-bottom: 1px solid var(--border-color); }
    tr + tr { border-top: 1px solid var(--border-color); }
    td input[type="checkbox"] { width: auto; margin-right: 8px; }
    .paid-row { text-decoration: line-through; color: var(--text-secondary); }

    /* Calendar */
    #calendar { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; }
    .calendar-day { background-color: var(--bg-secondary); border-radius: 6px; padding: 8px; min-height: 100px; font-size: 12px; }
    .calendar-day.other-month { background-color: #1a2438; }
    .calendar-day .day-number { font-weight: bold; }
    .calendar-day.today .day-number {
        border: 2px solid var(--accent-color);
        border-radius: 50%;
        width: 1.5em;
        height: 1.5em;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    .calendar-day .event { font-size: 10px; background-color: var(--accent-color); color: var(--bg-primary); padding: 2px 4px; border-radius: 4px; margin-top: 4px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    
    /* Auth & Modals */
    .auth-container { position: absolute; top: 16px; right: 16px; }
    .modal { position: fixed; inset: 0; background: rgba(15,23,42,0.85); backdrop-filter: blur(6px); display: flex; align-items: center; justify-content: center; z-index: 3000; }
    .modal-content { background:#1e293b; border:1px solid #334155; padding:24px; border-radius:12px; min-width:300px; color:#e2e8f0; text-align:center; position: relative; }
    .modal-close { position: absolute; top: 8px; right: 8px; background: transparent; border: 0; color: var(--text-secondary); font-size: 24px; cursor: pointer; }
    
    @media (max-width: 600px) {
      body { padding: 8px; }
      .card-header { flex-direction: column; align-items: flex-start; }
      .actions { flex-wrap: wrap; }
      .auth-container { position: static; margin-top: 16px; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="container">
    <div class="auth-container" id="auth-container">
        <div id="logged-out-view">
            <button class="btn" id="show-login-btn">Log In</button>
            <button class="btn" id="show-signup-btn">Create Account</button>
        </div>
        <div id="logged-in-view" class="hidden">
            <span id="user-email" class="small-text"></span>
            <button class="btn" id="logout-btn">Log Out</button>
        </div>
    </div>

    <header style="margin-bottom: 16px;">
      <h1>Check Log & Finance Tracker</h1>
      <div class="actions" style="flex-wrap: wrap; gap: 8px;">
        <div id="cloud-actions" class="hidden actions">
             <button class="btn" id="saveToCloudBtn">Save to Cloud</button>
             <button class="btn" id="syncFromCloudBtn">Sync from Cloud</button>
        </div>
        <button class="btn" id="downloadJsonBtn">Export Data</button>
        <label class="btn">Import Data <input accept="application/json" id="importJsonInput" style="display:none;" type="file"/></label>
        <button class="btn btn-danger" id="resetBtn">Reset Data</button>
      </div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="check-logs">Check Logs</button>
      <button class="tab-btn" data-tab="bills">Recurring Bills</button>
      <button class="tab-btn" data-tab="calendar-tab">Calendar</button>
      <button class="tab-btn" data-tab="search">Bill History</button>
    </div>

    <!-- Check Logs Tab -->
    <div id="check-logs" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h3>New Check Log</h3>
          <div class="actions">
            <button class="btn btn-primary" id="addCheckA">+ Log Check A (1st-15th)</button>
            <button class="btn btn-primary" id="addCheckB">+ Log Check B (16th-31st)</button>
          </div>
        </div>
      </div>
      <div id="checkLogHistory"></div>
    </div>

    <!-- Recurring Bills Tab -->
    <div id="bills" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h3>Manage Recurring Bills</h3>
          <button class="btn" id="addBillBtn">+ Add New Bill</button>
        </div>
        <div style="overflow-x:auto;">
          <table id="billsTable">
            <thead>
              <tr>
                <th>Bill Name</th>
                <th>Amount</th>
                <th>Due Day</th>
                <th>Type</th>
                <th>Total to Pay</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="billsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Calendar Tab -->
    <div id="calendar-tab" class="tab-content">
        <div class="card">
            <div class="card-header">
                <button id="prevMonth" class="btn">&lt;</button>
                <h3 id="calendar-header">Month Year</h3>
                <button id="nextMonth" class="btn">&gt;</button>
            </div>
            <div id="calendar-grid-header" style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 5px; font-weight: bold;">
                <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
            </div>
            <div id="calendar"></div>
        </div>
    </div>

    <!-- Search Tab -->
    <div id="search" class="tab-content">
        <div class="card">
            <div class="card-header">
                <h3>Bill Payment History</h3>
            </div>
            <select id="billSearchSelect"></select>
            <div id="billHistoryResults" style="margin-top: 16px;"></div>
        </div>
    </div>
  </div>

  <!-- Auth Modals -->
  <div id="login-modal" class="modal hidden">
      <div class="modal-content">
          <button class="modal-close">&times;</button>
          <h3>Log In</h3>
          <form id="login-form">
              <input id="login-email" type="email" placeholder="Email" required style="margin:8px 0;" />
              <input id="login-password" type="password" placeholder="Password" required style="margin:8px 0;" />
              <button type="submit" class="btn btn-primary" style="margin-top:12px;">Log In</button>
              <p id="login-error" class="small-text" style="color:#ef4444;margin-top:8px;display:none;"></p>
          </form>
      </div>
  </div>
  <div id="signup-modal" class="modal hidden">
      <div class="modal-content">
          <button class="modal-close">&times;</button>
          <h3>Create Account</h3>
          <form id="signup-form">
              <input id="signup-email" type="email" placeholder="Email" required style="margin:8px 0;" />
              <input id="signup-password" type="password" placeholder="Password" required style="margin:8px 0;" />
              <button type="submit" class="btn btn-primary" style="margin-top:12px;">Create Account</button>
              <p id="signup-error" class="small-text" style="color:#ef4444;margin-top:8px;display:none;"></p>
          </form>
      </div>
  </div>

  <script>
    (function() {
      'use strict';
      
      const DEFAULT_STATE = {
        bills: [],
        checkLogs: [],
      };

      let state;
      let currentCalendarDate = new Date();

      // --- State Management ---
      function applyLoadedState(newState) {
        state = newState;
        saveStateToLocal();
        renderAll();
      }
      window.applyLoadedState = applyLoadedState;

      function loadStateFromLocal() {
        let loadedState;
        try {
          const stored = localStorage.getItem('checklog-app-v1');
          loadedState = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(DEFAULT_STATE));
        } catch (e) {
          loadedState = JSON.parse(JSON.stringify(DEFAULT_STATE));
        }
        if (!loadedState || !Array.isArray(loadedState.bills)) {
            loadedState = JSON.parse(JSON.stringify(DEFAULT_STATE));
        }
        applyLoadedState(loadedState);
      }

      function saveStateToLocal() {
        try {
          localStorage.setItem('checklog-app-v1', JSON.stringify(state));
        } catch (e) {
            console.error("Failed to save state to localStorage", e);
        }
      }
      
      // --- Rendering ---
      function renderAll() {
        if (!state) return;
        renderBills();
        renderCheckLogs();
        renderCalendar();
        renderBillSearch();
      }

      function renderBills() {
        const tbody = document.getElementById('billsBody');
        tbody.innerHTML = '';
        state.bills.forEach(bill => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="text" value="${bill.name}" data-id="${bill.id}" data-prop="name" class="bill-input"></td>
            <td><input type="number" value="${bill.amount}" data-id="${bill.id}" data-prop="amount" class="bill-input"></td>
            <td><input type="number" value="${bill.dueDay}" data-id="${bill.id}" data-prop="dueDay" class="bill-input" min="1" max="31"></td>
            <td>
                <select data-id="${bill.id}" data-prop="type" class="bill-input">
                    <option value="ongoing" ${bill.type === 'ongoing' ? 'selected' : ''}>Ongoing</option>
                    <option value="limited" ${bill.type === 'limited' ? 'selected' : ''}>Limited</option>
                </select>
            </td>
            <td><input type="number" value="${bill.totalToPay || ''}" data-id="${bill.id}" data-prop="totalToPay" class="bill-input" ${bill.type !== 'limited' ? 'disabled' : ''}></td>
            <td><button class="btn btn-danger" data-id="${bill.id}">Remove</button></td>
          `;
          tbody.appendChild(tr);
        });
      }

      function renderCheckLogs() {
        const container = document.getElementById('checkLogHistory');
        container.innerHTML = '';
        [...state.checkLogs].sort((a,b) => b.id - a.id).forEach(log => {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.logId = log.id; // Add log-id to the card itself for easier access
            
            const balance = (log.checkAmount || 0) - log.items.reduce((sum, item) => sum + (item.paid ? (item.cost || 0) : 0), 0);
            
            let itemsHtml = '';
            let runningTotal = 0;
            log.items.forEach(item => {
                if (item.paid) {
                    runningTotal += (item.cost || 0);
                }
                itemsHtml += `
                    <tr class="${item.paid ? 'paid-row' : ''}" data-item-id="${item.id}">
                        <td><input type="checkbox" class="item-paid" ${item.paid ? 'checked' : ''}></td>
                        <td><input type="text" class="item-input" data-prop="bill" value="${item.bill}"></td>
                        <td><input type="number" class="item-input" data-prop="cost" value="${item.cost}"></td>
                        <td><input type="date" class="item-input" data-prop="dueDate" value="${item.dueDate}"></td>
                        <td class="running-total">${formatCurrency(runningTotal)}</td>
                        <td class="running-balance">${formatCurrency((log.checkAmount || 0) - runningTotal)}</td>
                        <td><button class="btn btn-danger remove-item-btn">X</button></td>
                    </tr>
                `;
            });

            card.innerHTML = `
                <div class="card-header">
                    <h3>${log.name} - ${log.month}/${log.year}</h3>
                    <div class="actions">
                        <span>Balance: <strong class="log-balance">${formatCurrency(balance)}</strong></span>
                        <button class="btn btn-danger delete-log-btn">Delete Log</button>
                    </div>
                </div>
                <div>
                    <label>Check Amount:</label>
                    <input type="number" class="check-amount-input" value="${log.checkAmount || ''}">
                </div>
                <div style="overflow-x:auto; margin-top: 16px;">
                    <table>
                        <thead>
                            <tr><th>Paid</th><th>Bill</th><th>Cost</th><th>Due Date</th><th>Running Total</th><th>Running Balance</th><th></th></tr>
                        </thead>
                        <tbody>${itemsHtml}</tbody>
                    </table>
                </div>
                <div class="actions" style="margin-top: 12px;">
                    <button class="btn add-item-btn">+ Add One-Time Bill</button>
                </div>
            `;
            container.appendChild(card);
        });
      }

      function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        const headerEl = document.getElementById('calendar-header');
        calendarEl.innerHTML = '';

        const today = new Date();
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        headerEl.textContent = `${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}`;

        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);

        // Add blank days for the start of the month
        for (let i = 0; i < firstDay.getDay(); i++) {
            calendarEl.innerHTML += `<div class="calendar-day other-month"></div>`;
        }
        
        // Add days of the month
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const isToday = day === today.getDate() && month === today.getMonth() && year === today.getFullYear();
            let dayHtml = `<div class="calendar-day ${isToday ? 'today' : ''}"><div class="day-number">${day}</div>`;
            state.bills.forEach(bill => {
                if (bill.dueDay == day) {
                    dayHtml += `<div class="event">${bill.name} - ${formatCurrency(bill.amount)}</div>`;
                }
            });
            dayHtml += `</div>`;
            calendarEl.innerHTML += dayHtml;
        }
      }
      
      function renderBillSearch() {
        const select = document.getElementById('billSearchSelect');
        const results = document.getElementById('billHistoryResults');
        select.innerHTML = '<option value="">Select a bill to see its history</option>';
        results.innerHTML = '';
        
        state.bills.forEach(bill => {
            select.innerHTML += `<option value="${bill.name}">${bill.name}</option>`;
        });
      }

      // --- Event Handlers & Logic ---
      function handleBillInputChange(e) {
        const id = parseInt(e.target.dataset.id);
        const prop = e.target.dataset.prop;
        const value = e.target.type === 'number' ? parseFloat(e.target.value) : e.target.value;
        const bill = state.bills.find(b => b.id === id);
        if (bill) {
          bill[prop] = value;
          if (prop === 'type' && value === 'ongoing') {
              delete bill.totalToPay;
          }
          saveStateToLocal();
          
          renderCalendar();

          if (prop === 'type') {
            renderBills();
          }
        }
      }
      
      function addBill() {
        const newId = (state.bills.length > 0) ? Math.max(...state.bills.map(b => b.id)) + 1 : 1;
        state.bills.push({ id: newId, name: 'New Bill', amount: 0, dueDay: 1, type: 'ongoing' });
        saveStateToLocal();
        renderBills();
      }

      function removeBill(id) {
        state.bills = state.bills.filter(b => b.id !== id);
        saveStateToLocal();
        renderBills();
        renderCalendar(); 
      }

      function addCheckLog(templateType) {
        const now = new Date();
        const newId = (state.checkLogs.length > 0) ? Math.max(...state.checkLogs.map(l => l.id)) + 1 : 1;
        const isTemplateA = templateType === 'A';
        
        const items = state.bills
            .filter(bill => isTemplateA ? (bill.dueDay >= 1 && bill.dueDay <= 15) : (bill.dueDay >= 16 && bill.dueDay <= 31))
            .map((bill, index) => ({
                id: index + 1,
                bill: bill.name,
                cost: bill.amount,
                dueDate: `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(bill.dueDay).padStart(2, '0')}`,
                paid: false
            }));

        state.checkLogs.push({
            id: newId,
            name: `Check ${templateType}`,
            month: now.getMonth() + 1,
            year: now.getFullYear(),
            checkAmount: 0,
            items: items
        });
        saveStateToLocal();
        renderCheckLogs();
      }
      
      function updateLogCalculations(log, logCard) {
        const totalPaid = log.items.reduce((sum, item) => sum + (item.paid ? (item.cost || 0) : 0), 0);
        const overallBalance = (log.checkAmount || 0) - totalPaid;
        logCard.querySelector('.log-balance').textContent = formatCurrency(overallBalance);

        let runningTotal = 0;
        logCard.querySelectorAll('tbody tr').forEach(tr => {
            const itemId = parseInt(tr.dataset.itemId);
            const item = log.items.find(i => i.id === itemId);
            if (!item) return;

            if (item.paid) {
                runningTotal += (item.cost || 0);
                tr.classList.add('paid-row');
            } else {
                tr.classList.remove('paid-row');
            }
            
            tr.querySelector('.running-total').textContent = formatCurrency(runningTotal);
            tr.querySelector('.running-balance').textContent = formatCurrency((log.checkAmount || 0) - runningTotal);
        });
      }

      function handleCheckLogInteraction(e) {
        const target = e.target;
        const logCard = target.closest('.card[data-log-id]');
        if (!logCard) return;

        const logId = parseInt(logCard.dataset.logId);
        const log = state.checkLogs.find(l => l.id === logId);
        if (!log) return;

        // Handle button clicks, which require a full re-render
        if (target.tagName === 'BUTTON') {
            if (target.classList.contains('add-item-btn')) {
                const newItemId = log.items.length > 0 ? Math.max(...log.items.map(i => i.id)) + 1 : 1;
                log.items.push({ id: newItemId, bill: 'One-time expense', cost: 0, dueDate: new Date().toISOString().split('T')[0], paid: false });
            } else if (target.classList.contains('delete-log-btn')) {
                if (confirm('Are you sure you want to delete this entire check log?')) {
                    state.checkLogs = state.checkLogs.filter(l => l.id !== logId);
                } else {
                    return; // Don't save or re-render if cancelled
                }
            } else if (target.classList.contains('remove-item-btn')) {
                const itemRow = target.closest('tr[data-item-id]');
                if (itemRow) {
                    const itemId = parseInt(itemRow.dataset.itemId);
                    log.items = log.items.filter(i => i.id !== itemId);
                }
            }
            saveStateToLocal();
            renderCheckLogs(); // Re-render after structural changes
            return;
        }

        // Handle input changes, which only update calculations, not the whole structure
        if (target.tagName === 'INPUT' || target.tagName === 'SELECT') {
            if (target.classList.contains('check-amount-input')) {
                log.checkAmount = parseFloat(target.value) || 0;
            } else {
                const itemRow = target.closest('tr[data-item-id]');
                if (itemRow) {
                    const itemId = parseInt(itemRow.dataset.itemId);
                    const item = log.items.find(i => i.id === itemId);
                    if (item) {
                        if (target.classList.contains('item-paid')) {
                            item.paid = target.checked;
                        } else {
                            const prop = target.dataset.prop;
                            item[prop] = target.type === 'number' ? parseFloat(target.value) : target.value;
                        }
                    }
                }
            }
            saveStateToLocal();
            updateLogCalculations(log, logCard);
        }
    }

      function showBillHistory(billName) {
        const resultsContainer = document.getElementById('billHistoryResults');
        if (!billName) {
            resultsContainer.innerHTML = '';
            return;
        }
        
        let html = `<h4>History for ${billName}</h4><ul>`;
        let count = 0;
        state.checkLogs.forEach(log => {
            log.items.forEach(item => {
                if (item.bill === billName && item.paid) {
                    html += `<li>Paid <strong>${formatCurrency(item.cost)}</strong> on Check ${log.name} (${log.month}/${log.year})</li>`;
                    count++;
                }
            });
        });
        
        if (count === 0) {
            html += '<li>No paid history found for this bill.</li>';
        }
        html += '</ul>';
        resultsContainer.innerHTML = html;
      }

      // --- Helpers ---
      function formatCurrency(n) {
        return (Number(n) || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
      }

      // --- Event Binding ---
      function bindEvents() {
        // Tabs
        document.querySelector('.tabs').addEventListener('click', e => {
          if (e.target.classList.contains('tab-btn')) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            e.target.classList.add('active');
            document.getElementById(e.target.dataset.tab).classList.add('active');
          }
        });

        // Bills
        document.getElementById('addBillBtn').onclick = addBill;
        document.getElementById('billsBody').addEventListener('change', handleBillInputChange);
        document.getElementById('billsBody').addEventListener('click', e => {
          if (e.target.tagName === 'BUTTON') {
            removeBill(parseInt(e.target.dataset.id));
          }
        });

        // Check Logs
        document.getElementById('addCheckA').onclick = () => addCheckLog('A');
        document.getElementById('addCheckB').onclick = () => addCheckLog('B');
        document.getElementById('checkLogHistory').addEventListener('change', handleCheckLogInteraction);
        document.getElementById('checkLogHistory').addEventListener('click', handleCheckLogInteraction);

        // Calendar
        document.getElementById('prevMonth').onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); renderCalendar(); };
        document.getElementById('nextMonth').onclick = () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); renderCalendar(); };

        // Search
        document.getElementById('billSearchSelect').addEventListener('change', e => showBillHistory(e.target.value));

        // Global Actions
        document.getElementById('downloadJsonBtn').onclick = () => {
          const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'checklog-data.json';
          a.click();
          URL.revokeObjectURL(a.href);
        };
        document.getElementById('importJsonInput').onchange = e => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = ev => {
              try {
                applyLoadedState(JSON.parse(ev.target.result));
              } catch { alert('Invalid JSON file.'); }
            };
            reader.readAsText(file);
          }
        };
        document.getElementById('resetBtn').onclick = () => {
          if (confirm('Are you sure you want to reset all data? This cannot be undone.')) {
            applyLoadedState(JSON.parse(JSON.stringify(DEFAULT_STATE)));
          }
        };
      }

      // --- Initialization ---
      loadStateFromLocal();
      bindEvents();
    })();

    // --- Supabase Integration ---
    (function() {
      const SUPABASE_URL = 'https://dxcvbuwjgswupqyijhav.supabase.co';
      const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4Y3ZidXdqZ3N3dXBxeWlqaGF2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyMDgzODMsImV4cCI6MjA3MDc4NDM4M30.fAocl5EEjrqLyY52n95TikqJYu1Injje-FlKtPR6Sjg';
      
      const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);
      let currentUser = null;
      let sessionPassword = null;

      // --- ONE-TIME SUPABASE SETUP ---
      // In your Supabase project, go to the "SQL Editor" and run the following command
      // to create the table required for this app to store data:
      /*
        CREATE TABLE app_data (
          user_id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
          payload JSONB,
          updated_at TIMESTAMPTZ DEFAULT NOW()
        );

        -- Then, enable Row Level Security (RLS) on the table
        ALTER TABLE app_data ENABLE ROW LEVEL SECURITY;

        -- And create policies to allow users to access only their own data
        CREATE POLICY "Users can insert their own data." ON app_data FOR INSERT WITH CHECK (auth.uid() = user_id);
        CREATE POLICY "Users can update their own data." ON app_data FOR UPDATE USING (auth.uid() = user_id);
        CREATE POLICY "Users can view their own data." ON app_data FOR SELECT USING (auth.uid() = user_id);
      */

      // Crypto Helpers
      const b64FromBuf = buf => btoa(String.fromCharCode(...new Uint8Array(buf)));
      const bufFromB64 = str => Uint8Array.from(atob(str), c => c.charCodeAt(0));
      async function deriveKey(pass, salt) {
        const keyMaterial = await crypto.subtle.importKey('raw', new TextEncoder().encode(pass), { name: 'PBKDF2' }, false, ['deriveKey']);
        return crypto.subtle.deriveKey({ name: 'PBKDF2', salt, iterations: 100000, hash: 'SHA-256' }, keyMaterial, { name: 'AES-GCM', length: 256 }, false, ['encrypt', 'decrypt']);
      }
      async function encryptStatePayload(stateObj, pass) {
        const salt = crypto.getRandomValues(new Uint8Array(16));
        const iv = crypto.getRandomValues(new Uint8Array(12));
        const key = await deriveKey(pass, salt);
        const plaintext = new TextEncoder().encode(JSON.stringify(stateObj));
        const ct = await crypto.subtle.encrypt({ name: 'AES-GCM', iv }, key, plaintext);
        return { v: 1, salt: b64FromBuf(salt), iv: b64FromBuf(iv), data: b64FromBuf(ct) };
      }
      async function decryptStatePayload(payload, pass) {
        const salt = bufFromB64(payload.salt);
        const iv = bufFromB64(payload.iv);
        const key = await deriveKey(pass, salt);
        const data = bufFromB64(payload.data);
        const pt = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, data);
        return JSON.parse(new TextDecoder().decode(pt));
      }

      // UI Update Functions
      function showLoggedInUI(user) {
        document.getElementById('logged-out-view').classList.add('hidden');
        document.getElementById('logged-in-view').classList.remove('hidden');
        document.getElementById('cloud-actions').classList.remove('hidden');
        document.getElementById('user-email').textContent = user.email;
      }

      function showLoggedOutUI() {
        document.getElementById('logged-out-view').classList.remove('hidden');
        document.getElementById('logged-in-view').classList.add('hidden');
        document.getElementById('cloud-actions').classList.add('hidden');
        document.getElementById('user-email').textContent = '';
      }

      // Cloud Functions
      async function saveDataToCloud() {
        if (!currentUser || !sessionPassword) return alert('You must be logged in to save to the cloud.');
        try {
          const stateToSave = JSON.parse(localStorage.getItem('checklog-app-v1'));
          const payload = await encryptStatePayload(stateToSave, sessionPassword);
          const { error } = await sb.from('app_data').upsert({ user_id: currentUser.id, payload: payload, updated_at: new Date().toISOString() });
          if (error) throw error;
          alert('Data saved to Cloud.');
        } catch (e) {
          console.error('Save error:', e);
          alert('Save to cloud failed. Check console for details.');
        }
      }

      async function syncDataFromCloud() {
        if (!currentUser || !sessionPassword) return alert('You must be logged in to sync from the cloud.');
        try {
          const { data, error } = await sb.from('app_data').select('payload').eq('user_id', currentUser.id).maybeSingle();
          if (error) throw error;
          if (!data) {
            alert('No cloud data found for this account.');
            return;
          }
          const newState = await decryptStatePayload(data.payload, sessionPassword);
          if (typeof window.applyLoadedState === 'function') {
            window.applyLoadedState(newState);
            alert('Data synced from Cloud.');
          }
        } catch (e) {
          console.error('Sync error:', e);
          alert('Load from cloud failed. Check console for details.');
        }
      }

      // Auth Event Listeners
      document.getElementById('show-login-btn').onclick = () => document.getElementById('login-modal').classList.remove('hidden');
      document.getElementById('show-signup-btn').onclick = () => document.getElementById('signup-modal').classList.remove('hidden');
      document.querySelectorAll('.modal-close').forEach(el => el.onclick = () => {
        el.closest('.modal').classList.add('hidden');
      });

      document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const { data, error } = await sb.auth.signInWithPassword({ email, password });
        if (error) {
          document.getElementById('login-error').textContent = error.message;
          document.getElementById('login-error').style.display = 'block';
        } else {
          sessionPassword = password; // Store password for session
          document.getElementById('login-modal').classList.add('hidden');
        }
      });

      document.getElementById('signup-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const { data, error } = await sb.auth.signUp({ email, password });
        if (error) {
          document.getElementById('signup-error').textContent = error.message;
          document.getElementById('signup-error').style.display = 'block';
        } else {
          sessionPassword = password; // Store password for session
          document.getElementById('signup-modal').classList.add('hidden');
          alert('Account created successfully! You are now logged in.');
        }
      });

      document.getElementById('logout-btn').addEventListener('click', async () => {
        await sb.auth.signOut();
        sessionPassword = null;
        currentUser = null;
        showLoggedOutUI();
        alert('You have been logged out.');
        window.location.reload(); // Reload to clear state and ensure local data is fresh
      });

      document.getElementById('saveToCloudBtn').onclick = saveDataToCloud;
      document.getElementById('syncFromCloudBtn').onclick = syncDataFromCloud;

      // Listen for auth state changes
      sb.auth.onAuthStateChange((event, session) => {
        if (session && session.user) {
          currentUser = session.user;
          showLoggedInUI(currentUser);
          if (sessionPassword) { // Only sync if we have the password from a fresh login/signup
             syncDataFromCloud();
          }
        } else {
          currentUser = null;
          showLoggedOutUI();
        }
      });

    })();
  </script>
</body>
</html>
